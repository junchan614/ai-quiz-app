<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - AIã‚¯ã‚¤ã‚ºç”Ÿæˆã‚¢ãƒ—ãƒª</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="nav">
                <div class="logo">
                    <h1>ğŸ§  AIã‚¯ã‚¤ã‚º</h1>
                </div>
                <div class="nav-links">
                    <button onclick="location.href='/dashboard.html'" class="btn btn-primary">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
                    <button onclick="location.href='/quiz.html'" class="btn btn-secondary">ã‚¯ã‚¤ã‚º</button>
                    <div class="auth-status" id="authStatus">
                        <span class="welcome-text" id="welcomeText">èª­ã¿è¾¼ã¿ä¸­...</span>
                        <button class="btn btn-secondary" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    </div>
                </div>
            </div>
        </header>

        <main class="main">
            <section class="dashboard-hero">
                <h2 class="hero-title">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
                <p class="hero-description">ãŠç–²ã‚Œã•ã¾ã§ã™ï¼ä»Šæ—¥ã‚‚ã‚¯ã‚¤ã‚ºã§çŸ¥è­˜ã‚’æ·±ã‚ã¾ã—ã‚‡ã†ã€‚</p>
            </section>

            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆ -->
            <section class="stats-section">
                <h3 class="section-title">ğŸ“Š ã‚ãªãŸã®æˆç¸¾</h3>
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalAnswers">-</div>
                        <div class="stat-label">ç·å›ç­”æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="correctAnswers">-</div>
                        <div class="stat-label">æ­£è§£æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="accuracyPercentage">-%</div>
                        <div class="stat-label">æ­£ç­”ç‡</div>
                    </div>
                </div>
            </section>

            <!-- ã‚¯ã‚¤ã‚ºé–‹å§‹ -->
            <section class="quiz-start-section">
                <h3 class="section-title">ğŸ¯ ã‚¯ã‚¤ã‚ºã«æŒ‘æˆ¦</h3>
                <div class="quiz-options">
                    <div class="quiz-option-card">
                        <h4>AIã‚¯ã‚¤ã‚ºç”Ÿæˆ</h4>
                        <p>ãŠå¥½ã¿ã®ãƒˆãƒ”ãƒƒã‚¯ã§AIãŒã‚¯ã‚¤ã‚ºã‚’è‡ªå‹•ç”Ÿæˆ</p>
                        <button class="btn btn-primary btn-full" onclick="startAIQuiz()">
                            ğŸ¤– AIã‚¯ã‚¤ã‚ºã‚’å§‹ã‚ã‚‹
                        </button>
                    </div>
                </div>
            </section>

            <!-- æœ€è¿‘ã®å±¥æ­´ -->
            <section class="history-section">
                <h3 class="section-title">ğŸ“ æœ€è¿‘ã®å›ç­”å±¥æ­´</h3>
                <div class="history-list" id="historyList">
                    <p class="text-center">å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
                <div class="text-center">
                    <button class="btn btn-secondary" onclick="loadMoreHistory()">
                        ã‚‚ã£ã¨è¦‹ã‚‹
                    </button>
                </div>
            </section>
        </main>

        <footer class="footer">
            <p>&copy; 2024 AIã‚¯ã‚¤ã‚ºç”Ÿæˆã‚¢ãƒ—ãƒª. All rights reserved.</p>
        </footer>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/app-state.js"></script>
    <script>
        let currentUser = null;

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰èª­ã¿è¾¼ã¿é–‹å§‹');
            
            // èªè¨¼ãƒã‚§ãƒƒã‚¯
            currentUser = await requireAuth();
            if (!currentUser) return;

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’appStateã«ä¿å­˜
            appState.setUser(currentUser);

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º
            updateWelcomeText();
            
            // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ç›£è¦–ã‚’è¨­å®š
            appState.subscribe('stats', displayUserStats);
            appState.subscribe('quizHistory', displayHistory);
            
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸçµ±è¨ˆãŒã‚ã‚Œã°å³åº§ã«è¡¨ç¤º
            const cachedStats = appState.getStats();
            if (cachedStats) {
                displayUserStats(cachedStats);
            }
            
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸå±¥æ­´ãŒã‚ã‚Œã°å³åº§ã«è¡¨ç¤º
            const cachedHistory = appState.loadFromStorage('quizHistory');
            if (cachedHistory && cachedHistory.length > 0) {
                displayHistory(cachedHistory.slice(0, 5)); // æœ€æ–°5ä»¶ã®ã¿è¡¨ç¤º
            }
            
            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚ˆã‚Šæ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯æ›´æ–°ï¼‰
            await Promise.all([
                loadUserStats(),
                loadRecentHistory()
            ]);
        });

        // ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°
        function updateWelcomeText() {
            const welcomeText = document.getElementById('welcomeText');
            welcomeText.textContent = `ã“ã‚“ã«ã¡ã¯ã€${currentUser.username}ã•ã‚“`;
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆã®èª­ã¿è¾¼ã¿
        async function loadUserStats() {
            try {
                const response = await fetch('/api/user/stats', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    // appStateã«ä¿å­˜ï¼ˆè‡ªå‹•çš„ã«UIæ›´æ–°ã•ã‚Œã‚‹ï¼‰
                    appState.setStats(data.stats);
                } else {
                    console.error('çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('çµ±è¨ˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤º
        function displayUserStats(stats) {
            document.getElementById('totalAnswers').textContent = stats.total_answers || 0;
            document.getElementById('correctAnswers').textContent = stats.correct_answers || 0;
            document.getElementById('accuracyPercentage').textContent = 
                (stats.accuracy_percentage || 0) + '%';
        }


        // æœ€è¿‘ã®å±¥æ­´èª­ã¿è¾¼ã¿
        async function loadRecentHistory() {
            try {
                const response = await fetch('/api/user/history?limit=5', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    // appStateã«ä¿å­˜ï¼ˆæœ€æ–°5ä»¶ã®ã¿è¡¨ç¤ºç”¨ï¼‰
                    appState.setQuizHistory(data.history);
                } else {
                    console.error('å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('historyList').innerHTML = '<p class="text-center">å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
            }
        }

        // å±¥æ­´ã®è¡¨ç¤º
        function displayHistory(history) {
            const historyList = document.getElementById('historyList');
            
            if (history.length === 0) {
                historyList.innerHTML = '<p class="text-center">ã¾ã ã‚¯ã‚¤ã‚ºã«å›ç­”ã—ã¦ã„ã¾ã›ã‚“ã€‚æœ€åˆã®ã‚¯ã‚¤ã‚ºã«æŒ‘æˆ¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>';
                return;
            }

            historyList.innerHTML = history.map(item => `
                <div class="history-item">
                    <div class="history-question">${item.question}</div>
                    <div class="history-details">
                        <span class="history-topic">${item.topic}</span>
                        <span class="history-result ${item.is_correct ? 'correct' : 'incorrect'}">
                            ${item.is_correct ? 'âœ… æ­£è§£' : 'âŒ ä¸æ­£è§£'}
                        </span>
                        <span class="history-date">${new Date(item.answered_at).toLocaleDateString()}</span>
                    </div>
                </div>
            `).join('');
        }

        // ãƒ©ãƒ³ãƒ€ãƒ ã‚¯ã‚¤ã‚ºé–‹å§‹
        async function startRandomQuiz() {
            console.log('ãƒ©ãƒ³ãƒ€ãƒ ã‚¯ã‚¤ã‚ºé–‹å§‹');
            try {
                const response = await fetch('/api/quiz/random/get', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    startQuizWithData(data.quiz);
                } else {
                    alert('ã‚¯ã‚¤ã‚ºã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('ãƒ©ãƒ³ãƒ€ãƒ ã‚¯ã‚¤ã‚ºã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¯ã‚¤ã‚ºã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // AIã‚¯ã‚¤ã‚ºç”Ÿæˆãƒšãƒ¼ã‚¸ã¸ç§»å‹•
        function startAIQuiz() {
            location.href = 'quiz.html';
        }

        // ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã§ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹
        function startQuizWithData(quiz) {
            // ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            sessionStorage.setItem('currentQuiz', JSON.stringify(quiz));
            
            // ã‚¯ã‚¤ã‚ºãƒšãƒ¼ã‚¸ã«ç§»å‹•
            location.href = 'quiz.html';
        }

        // å±¥æ­´ã‚’ã‚‚ã£ã¨èª­ã¿è¾¼ã¿
        function loadMoreHistory() {
            // å®Ÿè£…äºˆå®š: ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
            alert('ã“ã®æ©Ÿèƒ½ã¯å¾Œã§å®Ÿè£…äºˆå®šã§ã™');
        }
    </script>
</body>
</html>